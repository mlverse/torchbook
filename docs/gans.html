<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>12 Generative adversarial networks | Applied deep learning with torch from R</title>
  <meta name="description" content="tbd" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="12 Generative adversarial networks | Applied deep learning with torch from R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="tbd" />
  <meta property="og:image" content="tbdcover.png" />
  <meta property="og:description" content="tbd" />
  <meta name="github-repo" content="tbd" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="12 Generative adversarial networks | Applied deep learning with torch from R" />
  
  <meta name="twitter:description" content="tbd" />
  <meta name="twitter:image" content="tbdcover.png" />

<meta name="author" content="tbd" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="generative-intro.html"/>
<link rel="next" href="vaes.html"/>
<script src="libs/header-attrs-2.4.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#introduction-1"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
</ul></li>
<li class="part"><span><b>I Using Torch</b></span></li>
<li class="chapter" data-level="" data-path="using-torch-intro.html"><a href="using-torch-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="2" data-path="simple-net-R.html"><a href="simple-net-R.html"><i class="fa fa-check"></i><b>2</b> A simple neural network in R</a>
<ul>
<li class="chapter" data-level="2.1" data-path="simple-net-R.html"><a href="simple-net-R.html#whats-in-a-network"><i class="fa fa-check"></i><b>2.1</b> What’s in a network?</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="simple-net-R.html"><a href="simple-net-R.html#gradient-descent"><i class="fa fa-check"></i><b>2.1.1</b> Gradient descent</a></li>
<li class="chapter" data-level="2.1.2" data-path="simple-net-R.html"><a href="simple-net-R.html#from-linear-regression-to-a-simple-network"><i class="fa fa-check"></i><b>2.1.2</b> From linear regression to a simple network</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="simple-net-R.html"><a href="simple-net-R.html#a-simple-network"><i class="fa fa-check"></i><b>2.2</b> A simple network</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="simple-net-R.html"><a href="simple-net-R.html#simulate-data"><i class="fa fa-check"></i><b>2.2.1</b> Simulate data</a></li>
<li class="chapter" data-level="2.2.2" data-path="simple-net-R.html"><a href="simple-net-R.html#initialize-weights-and-biases"><i class="fa fa-check"></i><b>2.2.2</b> Initialize weights and biases</a></li>
<li class="chapter" data-level="2.2.3" data-path="simple-net-R.html"><a href="simple-net-R.html#training-loop"><i class="fa fa-check"></i><b>2.2.3</b> Training loop</a></li>
<li class="chapter" data-level="2.2.4" data-path="simple-net-R.html"><a href="simple-net-R.html#complete-code"><i class="fa fa-check"></i><b>2.2.4</b> Complete code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html"><i class="fa fa-check"></i><b>3</b> Modifying the simple network to use torch tensors</a>
<ul>
<li class="chapter" data-level="3.1" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html#tensors"><i class="fa fa-check"></i><b>3.1</b> Tensors</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html#creation"><i class="fa fa-check"></i><b>3.1.1</b> Creation</a></li>
<li class="chapter" data-level="3.1.2" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html#conversion-to-built-in-r-data-types"><i class="fa fa-check"></i><b>3.1.2</b> Conversion to built-in R data types</a></li>
<li class="chapter" data-level="3.1.3" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html#indexing-and-slicing-tensors"><i class="fa fa-check"></i><b>3.1.3</b> Indexing and slicing tensors</a></li>
<li class="chapter" data-level="3.1.4" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html#reshaping-tensors"><i class="fa fa-check"></i><b>3.1.4</b> Reshaping tensors</a></li>
<li class="chapter" data-level="3.1.5" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html#operations-on-tensors"><i class="fa fa-check"></i><b>3.1.5</b> Operations on tensors</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html#running-on-gpu"><i class="fa fa-check"></i><b>3.2</b> Running on GPU</a></li>
<li class="chapter" data-level="3.3" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html#broadcasting"><i class="fa fa-check"></i><b>3.3</b> Broadcasting</a></li>
<li class="chapter" data-level="3.4" data-path="simple-net-tensors.html"><a href="simple-net-tensors.html#simple-neural-network-using-torch-tensors"><i class="fa fa-check"></i><b>3.4</b> Simple neural network using <code>torch</code> tensors</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="simple-net-autograd.html"><a href="simple-net-autograd.html"><i class="fa fa-check"></i><b>4</b> Using autograd</a>
<ul>
<li class="chapter" data-level="4.1" data-path="simple-net-autograd.html"><a href="simple-net-autograd.html#automatic-differentiation-with-autograd"><i class="fa fa-check"></i><b>4.1</b> Automatic differentiation with <em>autograd</em></a></li>
<li class="chapter" data-level="4.2" data-path="simple-net-autograd.html"><a href="simple-net-autograd.html#the-simple-network-now-using-autograd"><i class="fa fa-check"></i><b>4.2</b> The simple network, now using <em>autograd</em></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="simple-net-modules.html"><a href="simple-net-modules.html"><i class="fa fa-check"></i><b>5</b> Using torch modules</a>
<ul>
<li class="chapter" data-level="5.1" data-path="simple-net-modules.html"><a href="simple-net-modules.html#modules"><i class="fa fa-check"></i><b>5.1</b> Modules</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="simple-net-modules.html"><a href="simple-net-modules.html#base-modules-layers"><i class="fa fa-check"></i><b>5.1.1</b> Base modules (“layers”)</a></li>
<li class="chapter" data-level="5.1.2" data-path="simple-net-modules.html"><a href="simple-net-modules.html#container-modules-models"><i class="fa fa-check"></i><b>5.1.2</b> Container modules (“models”)</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="simple-net-modules.html"><a href="simple-net-modules.html#simple-network-using-modules"><i class="fa fa-check"></i><b>5.2</b> Simple network using modules</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="simple-net-optim.html"><a href="simple-net-optim.html"><i class="fa fa-check"></i><b>6</b> Using <code>torch</code> optimizers</a>
<ul>
<li class="chapter" data-level="6.1" data-path="simple-net-optim.html"><a href="simple-net-optim.html#losses-and-loss-functions"><i class="fa fa-check"></i><b>6.1</b> Losses and loss functions</a></li>
<li class="chapter" data-level="6.2" data-path="simple-net-optim.html"><a href="simple-net-optim.html#optimizers"><i class="fa fa-check"></i><b>6.2</b> Optimizers</a></li>
<li class="chapter" data-level="6.3" data-path="simple-net-optim.html"><a href="simple-net-optim.html#simple-network-final-version"><i class="fa fa-check"></i><b>6.3</b> Simple network: final version</a></li>
</ul></li>
<li class="part"><span><b>II Image Recognition</b></span></li>
<li class="chapter" data-level="" data-path="image-recognition-intro.html"><a href="image-recognition-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="7" data-path="image-classification.html"><a href="image-classification.html"><i class="fa fa-check"></i><b>7</b> Classifying images</a>
<ul>
<li class="chapter" data-level="7.1" data-path="image-classification.html"><a href="image-classification.html#data-loading-and-preprocessing"><i class="fa fa-check"></i><b>7.1</b> Data loading and preprocessing</a></li>
<li class="chapter" data-level="7.2" data-path="image-classification.html"><a href="image-classification.html#model"><i class="fa fa-check"></i><b>7.2</b> Model</a></li>
<li class="chapter" data-level="7.3" data-path="image-classification.html"><a href="image-classification.html#training"><i class="fa fa-check"></i><b>7.3</b> Training</a></li>
<li class="chapter" data-level="7.4" data-path="image-classification.html"><a href="image-classification.html#test-set-accuracy"><i class="fa fa-check"></i><b>7.4</b> Test set accuracy</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="unet.html"><a href="unet.html"><i class="fa fa-check"></i><b>8</b> Brain Image Segmentation with U-Net</a>
<ul>
<li class="chapter" data-level="8.1" data-path="unet.html"><a href="unet.html#image-segmentation-in-a-nutshell"><i class="fa fa-check"></i><b>8.1</b> Image segmentation in a nutshell</a></li>
<li class="chapter" data-level="8.2" data-path="unet.html"><a href="unet.html#u-net"><i class="fa fa-check"></i><b>8.2</b> U-Net</a></li>
<li class="chapter" data-level="8.3" data-path="unet.html"><a href="unet.html#example-application-mri-images"><i class="fa fa-check"></i><b>8.3</b> Example application: MRI images</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="unet.html"><a href="unet.html#preprocessing"><i class="fa fa-check"></i><b>8.3.1</b> Preprocessing</a></li>
<li class="chapter" data-level="8.3.2" data-path="unet.html"><a href="unet.html#u-net-model"><i class="fa fa-check"></i><b>8.3.2</b> U-Net model</a></li>
<li class="chapter" data-level="8.3.3" data-path="unet.html"><a href="unet.html#loss"><i class="fa fa-check"></i><b>8.3.3</b> Loss</a></li>
<li class="chapter" data-level="8.3.4" data-path="unet.html"><a href="unet.html#training-1"><i class="fa fa-check"></i><b>8.3.4</b> Training</a></li>
<li class="chapter" data-level="8.3.5" data-path="unet.html"><a href="unet.html#predictions"><i class="fa fa-check"></i><b>8.3.5</b> Predictions</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Natural language processing</b></span></li>
<li class="chapter" data-level="" data-path="NLP-intro.html"><a href="NLP-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="9" data-path="seq2seq-att.html"><a href="seq2seq-att.html"><i class="fa fa-check"></i><b>9</b> Sequence-to-sequence models with attention</a>
<ul>
<li class="chapter" data-level="9.1" data-path="seq2seq-att.html"><a href="seq2seq-att.html#why-attention"><i class="fa fa-check"></i><b>9.1</b> Why attention?</a></li>
<li class="chapter" data-level="9.2" data-path="seq2seq-att.html"><a href="seq2seq-att.html#preprocessing-with-torchtext"><i class="fa fa-check"></i><b>9.2</b> Preprocessing with <code>torchtext</code></a></li>
<li class="chapter" data-level="9.3" data-path="seq2seq-att.html"><a href="seq2seq-att.html#model-1"><i class="fa fa-check"></i><b>9.3</b> Model</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="seq2seq-att.html"><a href="seq2seq-att.html#encoder"><i class="fa fa-check"></i><b>9.3.1</b> Encoder</a></li>
<li class="chapter" data-level="9.3.2" data-path="seq2seq-att.html"><a href="seq2seq-att.html#attention-module"><i class="fa fa-check"></i><b>9.3.2</b> Attention module</a></li>
<li class="chapter" data-level="9.3.3" data-path="seq2seq-att.html"><a href="seq2seq-att.html#decoder"><i class="fa fa-check"></i><b>9.3.3</b> Decoder</a></li>
<li class="chapter" data-level="9.3.4" data-path="seq2seq-att.html"><a href="seq2seq-att.html#seq2seq-module"><i class="fa fa-check"></i><b>9.3.4</b> Seq2seq module</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="seq2seq-att.html"><a href="seq2seq-att.html#training-and-evaluation"><i class="fa fa-check"></i><b>9.4</b> Training and evaluation</a></li>
<li class="chapter" data-level="9.5" data-path="seq2seq-att.html"><a href="seq2seq-att.html#results"><i class="fa fa-check"></i><b>9.5</b> Results</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="transformer.html"><a href="transformer.html"><i class="fa fa-check"></i><b>10</b> Torch transformer modules</a>
<ul>
<li class="chapter" data-level="10.1" data-path="transformer.html"><a href="transformer.html#attention-is-all-you-need"><i class="fa fa-check"></i><b>10.1</b> “Attention is all you need”</a></li>
<li class="chapter" data-level="10.2" data-path="transformer.html"><a href="transformer.html#implementation-building-blocks"><i class="fa fa-check"></i><b>10.2</b> Implementation: building blocks</a></li>
<li class="chapter" data-level="10.3" data-path="transformer.html"><a href="transformer.html#a-transformer-for-natural-language-translation"><i class="fa fa-check"></i><b>10.3</b> A Transformer for natural language translation</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="transformer.html"><a href="transformer.html#load-data"><i class="fa fa-check"></i><b>10.3.1</b> Load data</a></li>
<li class="chapter" data-level="10.3.2" data-path="transformer.html"><a href="transformer.html#encoder-1"><i class="fa fa-check"></i><b>10.3.2</b> Encoder</a></li>
<li class="chapter" data-level="10.3.3" data-path="transformer.html"><a href="transformer.html#decoder-1"><i class="fa fa-check"></i><b>10.3.3</b> Decoder</a></li>
<li class="chapter" data-level="10.3.4" data-path="transformer.html"><a href="transformer.html#overall-model"><i class="fa fa-check"></i><b>10.3.4</b> Overall model</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="transformer.html"><a href="transformer.html#results-1"><i class="fa fa-check"></i><b>10.4</b> Results</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="tabular.html"><a href="tabular.html"><i class="fa fa-check"></i><b>11</b> torch for tabular data</a>
<ul>
<li class="chapter" data-level="11.1" data-path="tabular.html"><a href="tabular.html#agenda"><i class="fa fa-check"></i><b>11.1</b> Agenda</a></li>
<li class="chapter" data-level="11.2" data-path="tabular.html"><a href="tabular.html#dataset"><i class="fa fa-check"></i><b>11.2</b> Dataset</a></li>
<li class="chapter" data-level="11.3" data-path="tabular.html"><a href="tabular.html#model-2"><i class="fa fa-check"></i><b>11.3</b> Model</a></li>
<li class="chapter" data-level="11.4" data-path="tabular.html"><a href="tabular.html#training-2"><i class="fa fa-check"></i><b>11.4</b> Training</a></li>
<li class="chapter" data-level="11.5" data-path="tabular.html"><a href="tabular.html#evaluation"><i class="fa fa-check"></i><b>11.5</b> Evaluation</a></li>
<li class="chapter" data-level="11.6" data-path="tabular.html"><a href="tabular.html#making-the-task-harder"><i class="fa fa-check"></i><b>11.6</b> Making the task harder</a></li>
<li class="chapter" data-level="11.7" data-path="tabular.html"><a href="tabular.html#a-look-at-the-hidden-representations"><i class="fa fa-check"></i><b>11.7</b> A look at the hidden representations</a></li>
</ul></li>
<li class="part"><span><b>IV Time series</b></span></li>
<li class="chapter" data-level="" data-path="timeseries-intro.html"><a href="timeseries-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="part"><span><b>V Generative deep learning</b></span></li>
<li class="chapter" data-level="" data-path="generative-intro.html"><a href="generative-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="12" data-path="gans.html"><a href="gans.html"><i class="fa fa-check"></i><b>12</b> Generative adversarial networks</a>
<ul>
<li class="chapter" data-level="12.1" data-path="gans.html"><a href="gans.html#dataset-1"><i class="fa fa-check"></i><b>12.1</b> Dataset</a></li>
<li class="chapter" data-level="12.2" data-path="gans.html"><a href="gans.html#model-3"><i class="fa fa-check"></i><b>12.2</b> Model</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="gans.html"><a href="gans.html#generator"><i class="fa fa-check"></i><b>12.2.1</b> Generator</a></li>
<li class="chapter" data-level="12.2.2" data-path="gans.html"><a href="gans.html#discriminator"><i class="fa fa-check"></i><b>12.2.2</b> Discriminator</a></li>
<li class="chapter" data-level="12.2.3" data-path="gans.html"><a href="gans.html#optimizers-and-loss-function"><i class="fa fa-check"></i><b>12.2.3</b> Optimizers and loss function</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="gans.html"><a href="gans.html#training-loop-3"><i class="fa fa-check"></i><b>12.3</b> Training loop</a></li>
<li class="chapter" data-level="12.4" data-path="gans.html"><a href="gans.html#artifacts"><i class="fa fa-check"></i><b>12.4</b> Artifacts</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="vaes.html"><a href="vaes.html"><i class="fa fa-check"></i><b>13</b> Variational autoencoders</a>
<ul>
<li class="chapter" data-level="13.1" data-path="vaes.html"><a href="vaes.html#dataset-2"><i class="fa fa-check"></i><b>13.1</b> Dataset</a></li>
<li class="chapter" data-level="13.2" data-path="vaes.html"><a href="vaes.html#model-4"><i class="fa fa-check"></i><b>13.2</b> Model</a></li>
<li class="chapter" data-level="13.3" data-path="vaes.html"><a href="vaes.html#training-the-vae"><i class="fa fa-check"></i><b>13.3</b> Training the VAE</a></li>
<li class="chapter" data-level="13.4" data-path="vaes.html"><a href="vaes.html#latent-space"><i class="fa fa-check"></i><b>13.4</b> Latent space</a></li>
</ul></li>
<li class="part"><span><b>VI Deep learning on graphs</b></span></li>
<li class="chapter" data-level="" data-path="graph-intro.html"><a href="graph-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="part"><span><b>VII Probabilistic deep learning</b></span></li>
<li class="chapter" data-level="" data-path="probabilistic-intro.html"><a href="probabilistic-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="part"><span><b>VIII Private and secure deep learning</b></span></li>
<li class="chapter" data-level="" data-path="private-secure-intro.html"><a href="private-secure-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="part"><span><b>IX Research topics</b></span></li>
<li class="chapter" data-level="" data-path="research-intro.html"><a href="research-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Applied deep learning with torch from R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="gans" class="section level1" number="12">
<h1><span class="header-section-number">12</span> Generative adversarial networks</h1>
<p><em>Generative Adversarial Networks</em> (GANs) are one of the most successful, as of this writing, unsupervised (or self-supervised,
rather) deep learning architectures . In GANs, there is no well-defined loss function; instead, the setup is fundamentally
game-theoretic: Two actors, the <em>generator</em> and the <em>discriminator</em>, each try to minimize their loss; the outcome should be
some artifact – image, text, what have you – that resembles the training data but does not copy them.</p>
<p>In theory, this is a highly fascinating approach; in practice, it can be a challenge to set parameters in a way that good
results are achieved. The architecture and settings presented here follow those reported in the original DCGAN article
<span class="citation">(<a href="references.html#ref-goodfellow2014generative" role="doc-biblioref">Goodfellow et al. 2014</a>)</span>. In the meantime, a lot of research has been done; minor changes to loss functions, optimizers
and/or parameters may make an important difference.</p>
<div id="dataset-1" class="section level2" number="12.1">
<h2><span class="header-section-number">12.1</span> Dataset</h2>
<p>For this task, we use <a href="https://github.com/rois-codh/kmnist">Kuzushiji-MNIST</a> <span class="citation">(<a href="references.html#ref-clanuwat2018deep" role="doc-biblioref">Clanuwat et al. 2018</a>)</span>, one of the more recent MNIST
drop-ins. Kuzushiji-MNIST contains 70,000 grayscale images, of size 28x28 px just like MNIST, and also like MNIST, divided
into 10 classes.</p>
<p>We can use <code>torch</code> for loading it. With an unsupervised learning task such as this one, we only need the training set:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="gans.html#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(torch)</span>
<span id="cb288-2"><a href="gans.html#cb288-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-3"><a href="gans.html#cb288-3" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">128</span></span>
<span id="cb288-4"><a href="gans.html#cb288-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-5"><a href="gans.html#cb288-5" aria-hidden="true" tabindex="-1"></a>kmnist <span class="ot">&lt;-</span> <span class="fu">kmnist_dataset</span>(</span>
<span id="cb288-6"><a href="gans.html#cb288-6" aria-hidden="true" tabindex="-1"></a>    dir,</span>
<span id="cb288-7"><a href="gans.html#cb288-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">download =</span> <span class="cn">TRUE</span>,</span>
<span id="cb288-8"><a href="gans.html#cb288-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">transform =</span> <span class="cf">function</span>(x) {</span>
<span id="cb288-9"><a href="gans.html#cb288-9" aria-hidden="true" tabindex="-1"></a>        x <span class="ot">&lt;-</span> x<span class="sc">$</span><span class="fu">to</span>(<span class="at">dtype =</span> <span class="fu">torch_float</span>())<span class="sc">/</span><span class="dv">256</span></span>
<span id="cb288-10"><a href="gans.html#cb288-10" aria-hidden="true" tabindex="-1"></a>        x[newaxis,..]</span>
<span id="cb288-11"><a href="gans.html#cb288-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb288-12"><a href="gans.html#cb288-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb288-13"><a href="gans.html#cb288-13" aria-hidden="true" tabindex="-1"></a>dl <span class="ot">&lt;-</span> <span class="fu">dataloader</span>(kmnist, <span class="at">batch_size =</span> batch_size, <span class="at">shuffle =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Let’s view a few of those. Here are the initial 16 images, taken from the very first batch:</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="gans.html#cb289-1" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> dl<span class="sc">$</span><span class="fu">.iter</span>()<span class="sc">$</span><span class="fu">.next</span>()[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>, <span class="dv">1</span>, , ] </span>
<span id="cb289-2"><a href="gans.html#cb289-2" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> <span class="fu">normalize</span>(images) <span class="sc">%&gt;%</span> <span class="fu">as_array</span>()</span>
<span id="cb289-3"><a href="gans.html#cb289-3" aria-hidden="true" tabindex="-1"></a>images <span class="sc">%&gt;%</span></span>
<span id="cb289-4"><a href="gans.html#cb289-4" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">array_tree</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb289-5"><a href="gans.html#cb289-5" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(as.raster) <span class="sc">%&gt;%</span></span>
<span id="cb289-6"><a href="gans.html#cb289-6" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">iwalk</span>(<span class="sc">~</span>{<span class="fu">plot</span>(.x)})</span></code></pre></div>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="gans.html#cb290-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;images/gan_real.png&quot;</span>)</span></code></pre></div>
</div>
<div id="model-3" class="section level2" number="12.2">
<h2><span class="header-section-number">12.2</span> Model</h2>
<p>The model, in the abstract sense, consists of the interplay of two models, in the concrete sense – two <code>torch</code> <em>modules</em>. The
<em>generator</em> produces fake artifacts – fake Kuzushiji digits, in our case – in the hope of getting better and better at it;
the <em>discriminator</em> is tasked with telling actual from fake images. (Its task should, if all goes well, get more difficult
over time.)</p>
<p>Let’s start with the generator.</p>
<div id="generator" class="section level3" number="12.2.1">
<h3><span class="header-section-number">12.2.1</span> Generator</h3>
<p>The generator is given a random noise vector (1d), and has to produce images (2d, of a given resolution). Its main mode of
action is repeated application of <em>transposed convolutions</em> that upsample from a resolution of <code>1x1</code> to the required
resolution of <code>28x28</code>.</p>
<p>Following the DCGAN paper, the generator’s <code>nn_conv_transpose2d</code> and <code>nn_batch_norm2d</code> layers are initialized according to a
normal distribution with mean 0 and standard deviation 0.02.</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="gans.html#cb291-1" aria-hidden="true" tabindex="-1"></a>device <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">cuda_is_available</span>()) <span class="fu">torch_device</span>(<span class="st">&quot;cuda:0&quot;</span>) <span class="cf">else</span> <span class="st">&quot;cpu&quot;</span></span>
<span id="cb291-2"><a href="gans.html#cb291-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-3"><a href="gans.html#cb291-3" aria-hidden="true" tabindex="-1"></a>latent_input_size <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb291-4"><a href="gans.html#cb291-4" aria-hidden="true" tabindex="-1"></a>image_size <span class="ot">&lt;-</span> <span class="dv">28</span></span>
<span id="cb291-5"><a href="gans.html#cb291-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-6"><a href="gans.html#cb291-6" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">&lt;-</span> <span class="fu">nn_module</span>(</span>
<span id="cb291-7"><a href="gans.html#cb291-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;generator&quot;</span>,</span>
<span id="cb291-8"><a href="gans.html#cb291-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb291-9"><a href="gans.html#cb291-9" aria-hidden="true" tabindex="-1"></a>        self<span class="sc">$</span>main <span class="ot">=</span> <span class="fu">nn_sequential</span>(</span>
<span id="cb291-10"><a href="gans.html#cb291-10" aria-hidden="true" tabindex="-1"></a>            <span class="co"># nn_conv_transpose2d(in_channels, out_channels, kernel_size, stride=1, padding=0, output_padding=0, groups=1, bias=TRUE, dilation=1, padding_mode=&#39;zeros&#39;)</span></span>
<span id="cb291-11"><a href="gans.html#cb291-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># h_out = (h_in - 1) * stride - 2 * padding + dilation * (kernel_size - 1) + output_padding + 1</span></span>
<span id="cb291-12"><a href="gans.html#cb291-12" aria-hidden="true" tabindex="-1"></a>            <span class="co"># (1 - 1) * 1 - 2 * 0 + 1 * (4 -1 ) + 0 + 1</span></span>
<span id="cb291-13"><a href="gans.html#cb291-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 4 x 4</span></span>
<span id="cb291-14"><a href="gans.html#cb291-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_conv_transpose2d</span>(latent_input_size, image_size <span class="sc">*</span> <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="at">bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb291-15"><a href="gans.html#cb291-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_batch_norm2d</span>(image_size <span class="sc">*</span> <span class="dv">4</span>),</span>
<span id="cb291-16"><a href="gans.html#cb291-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_relu</span>(),</span>
<span id="cb291-17"><a href="gans.html#cb291-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 8 * 8</span></span>
<span id="cb291-18"><a href="gans.html#cb291-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_conv_transpose2d</span>(image_size <span class="sc">*</span> <span class="dv">4</span>, image_size <span class="sc">*</span> <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="at">bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb291-19"><a href="gans.html#cb291-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_batch_norm2d</span>(image_size <span class="sc">*</span> <span class="dv">2</span>),</span>
<span id="cb291-20"><a href="gans.html#cb291-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_relu</span>(),</span>
<span id="cb291-21"><a href="gans.html#cb291-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 16 x 16</span></span>
<span id="cb291-22"><a href="gans.html#cb291-22" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_conv_transpose2d</span>(image_size <span class="sc">*</span> <span class="dv">2</span>, image_size, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="at">bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb291-23"><a href="gans.html#cb291-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_batch_norm2d</span>(image_size),</span>
<span id="cb291-24"><a href="gans.html#cb291-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_relu</span>(),</span>
<span id="cb291-25"><a href="gans.html#cb291-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 28 x 28</span></span>
<span id="cb291-26"><a href="gans.html#cb291-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_conv_transpose2d</span>(image_size, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="at">bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb291-27"><a href="gans.html#cb291-27" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_tanh</span>()</span>
<span id="cb291-28"><a href="gans.html#cb291-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb291-29"><a href="gans.html#cb291-29" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb291-30"><a href="gans.html#cb291-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">forward =</span> <span class="cf">function</span>(x) {</span>
<span id="cb291-31"><a href="gans.html#cb291-31" aria-hidden="true" tabindex="-1"></a>        self<span class="sc">$</span><span class="fu">main</span>(x)</span>
<span id="cb291-32"><a href="gans.html#cb291-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb291-33"><a href="gans.html#cb291-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb291-34"><a href="gans.html#cb291-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-35"><a href="gans.html#cb291-35" aria-hidden="true" tabindex="-1"></a>gen <span class="ot">&lt;-</span> <span class="fu">generator</span>()</span>
<span id="cb291-36"><a href="gans.html#cb291-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-37"><a href="gans.html#cb291-37" aria-hidden="true" tabindex="-1"></a>init_weights <span class="ot">&lt;-</span> <span class="cf">function</span>(m) {</span>
<span id="cb291-38"><a href="gans.html#cb291-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">&quot;conv&quot;</span>, m<span class="sc">$</span>.classes[[<span class="dv">1</span>]])) {</span>
<span id="cb291-39"><a href="gans.html#cb291-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nn_init_normal_</span>(m<span class="sc">$</span>weight<span class="sc">$</span><span class="fu">data</span>(), <span class="fl">0.0</span>, <span class="fl">0.02</span>)</span>
<span id="cb291-40"><a href="gans.html#cb291-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">&quot;batch_norm&quot;</span>, m<span class="sc">$</span>.classes[[<span class="dv">1</span>]])) {</span>
<span id="cb291-41"><a href="gans.html#cb291-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nn_init_normal_</span>(m<span class="sc">$</span>weight<span class="sc">$</span><span class="fu">data</span>(), <span class="fl">1.0</span>, <span class="fl">0.02</span>)</span>
<span id="cb291-42"><a href="gans.html#cb291-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nn_init_constant_</span>(m<span class="sc">$</span>bias<span class="sc">$</span><span class="fu">data</span>(), <span class="dv">0</span>)</span>
<span id="cb291-43"><a href="gans.html#cb291-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb291-44"><a href="gans.html#cb291-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb291-45"><a href="gans.html#cb291-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-46"><a href="gans.html#cb291-46" aria-hidden="true" tabindex="-1"></a>gen[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">apply</span>(init_weights)</span>
<span id="cb291-47"><a href="gans.html#cb291-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-48"><a href="gans.html#cb291-48" aria-hidden="true" tabindex="-1"></a>disc<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> device)</span></code></pre></div>
</div>
<div id="discriminator" class="section level3" number="12.2.2">
<h3><span class="header-section-number">12.2.2</span> Discriminator</h3>
<p>The discriminator is a pretty conventional convnet. Its layers’ weights are initialized in the same way as the generator’s.</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="gans.html#cb292-1" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">&lt;-</span> <span class="fu">nn_module</span>(</span>
<span id="cb292-2"><a href="gans.html#cb292-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;discriminator&quot;</span>,</span>
<span id="cb292-3"><a href="gans.html#cb292-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb292-4"><a href="gans.html#cb292-4" aria-hidden="true" tabindex="-1"></a>        self<span class="sc">$</span>main <span class="ot">=</span> <span class="fu">nn_sequential</span>(</span>
<span id="cb292-5"><a href="gans.html#cb292-5" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 14 x 14</span></span>
<span id="cb292-6"><a href="gans.html#cb292-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_conv2d</span>(<span class="dv">1</span>, image_size, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="at">bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb292-7"><a href="gans.html#cb292-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_leaky_relu</span>(<span class="fl">0.2</span>, <span class="at">inplace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb292-8"><a href="gans.html#cb292-8" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 7 x 7</span></span>
<span id="cb292-9"><a href="gans.html#cb292-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_conv2d</span>(image_size, image_size <span class="sc">*</span> <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>,  <span class="at">bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb292-10"><a href="gans.html#cb292-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_batch_norm2d</span>(image_size <span class="sc">*</span> <span class="dv">2</span>),</span>
<span id="cb292-11"><a href="gans.html#cb292-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_leaky_relu</span>(<span class="fl">0.2</span>, <span class="at">inplace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb292-12"><a href="gans.html#cb292-12" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 3 x 3</span></span>
<span id="cb292-13"><a href="gans.html#cb292-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_conv2d</span>(image_size <span class="sc">*</span> <span class="dv">2</span>, image_size <span class="sc">*</span> <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>,  <span class="at">bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb292-14"><a href="gans.html#cb292-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_batch_norm2d</span>(image_size <span class="sc">*</span> <span class="dv">4</span>),</span>
<span id="cb292-15"><a href="gans.html#cb292-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_leaky_relu</span>(<span class="fl">0.2</span>, <span class="at">inplace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb292-16"><a href="gans.html#cb292-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 1 x 1</span></span>
<span id="cb292-17"><a href="gans.html#cb292-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_conv2d</span>(image_size <span class="sc">*</span> <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>,  <span class="at">bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb292-18"><a href="gans.html#cb292-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nn_sigmoid</span>()</span>
<span id="cb292-19"><a href="gans.html#cb292-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb292-20"><a href="gans.html#cb292-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb292-21"><a href="gans.html#cb292-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">forward =</span> <span class="cf">function</span>(x) {</span>
<span id="cb292-22"><a href="gans.html#cb292-22" aria-hidden="true" tabindex="-1"></a>        self<span class="sc">$</span><span class="fu">main</span>(x)</span>
<span id="cb292-23"><a href="gans.html#cb292-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb292-24"><a href="gans.html#cb292-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb292-25"><a href="gans.html#cb292-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-26"><a href="gans.html#cb292-26" aria-hidden="true" tabindex="-1"></a>disc <span class="ot">&lt;-</span> <span class="fu">discriminator</span>()</span>
<span id="cb292-27"><a href="gans.html#cb292-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-28"><a href="gans.html#cb292-28" aria-hidden="true" tabindex="-1"></a>disc[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">apply</span>(init_weights)</span>
<span id="cb292-29"><a href="gans.html#cb292-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-30"><a href="gans.html#cb292-30" aria-hidden="true" tabindex="-1"></a>disc<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> device)</span></code></pre></div>
</div>
<div id="optimizers-and-loss-function" class="section level3" number="12.2.3">
<h3><span class="header-section-number">12.2.3</span> Optimizers and loss function</h3>
<p>While generator and discriminator each need to account for their own losses, mathematically both use the same calculation,
namely, binary crossentropy:</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="gans.html#cb293-1" aria-hidden="true" tabindex="-1"></a>criterion <span class="ot">&lt;-</span> <span class="fu">nn_bce_loss</span>()</span></code></pre></div>
<p>They each have their own optimizer:</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="gans.html#cb294-1" aria-hidden="true" tabindex="-1"></a>learning_rate <span class="ot">&lt;-</span> <span class="fl">0.0002</span></span>
<span id="cb294-2"><a href="gans.html#cb294-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-3"><a href="gans.html#cb294-3" aria-hidden="true" tabindex="-1"></a>disc_optimizer <span class="ot">&lt;-</span> <span class="fu">optim_adam</span>(disc<span class="sc">$</span>parameters, <span class="at">lr =</span> learning_rate, <span class="at">betas =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.999</span>))</span>
<span id="cb294-4"><a href="gans.html#cb294-4" aria-hidden="true" tabindex="-1"></a>gen_optimizer <span class="ot">&lt;-</span> <span class="fu">optim_adam</span>(gen<span class="sc">$</span>parameters, <span class="at">lr =</span> learning_rate, <span class="at">betas =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.999</span>))</span></code></pre></div>
</div>
</div>
<div id="training-loop-3" class="section level2" number="12.3">
<h2><span class="header-section-number">12.3</span> Training loop</h2>
<p>Each epoch, the training loop consists of three parts.</p>
<p>First, the discriminator is trained. This, logically, is a two-step procedure (with no time dependencies between steps). In
step 1, it is given the real images, together with labels (fabricated on the fly) that say “these are real images.” Binary
cross entropy will be minimized when all those images are, in fact, classified as real by the discriminator. In stage 2, first
the generator is asked to generate some images, and then the discriminator is asked to rate them. Again, binary cross entropy
is calculated, but this time, it will be minimal if all images are characterized as fake. Once gradients have been obtained
for both computations, the discriminator’s weights are updated.</p>
<p>Then it’s the generator’s turn – although in an indirect way. We pass the newly generated fakes to the <em>discriminator</em> again;
only this time, the desired verdict is “no fake,” so the labels are set to “real.” The binary cross entropy loss then reflects
the <em>generator’s</em> performance, not that of the discriminator.</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="gans.html#cb295-1" aria-hidden="true" tabindex="-1"></a>fixed_noise <span class="ot">&lt;-</span> <span class="fu">torch_randn</span>(<span class="fu">c</span>(<span class="dv">64</span>, latent_input_size, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">device =</span> device)</span>
<span id="cb295-2"><a href="gans.html#cb295-2" aria-hidden="true" tabindex="-1"></a>num_epochs <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb295-3"><a href="gans.html#cb295-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-4"><a href="gans.html#cb295-4" aria-hidden="true" tabindex="-1"></a>img_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="at">length =</span> num_epochs <span class="sc">*</span> <span class="fu">trunc</span>(dl<span class="sc">$</span><span class="fu">.iter</span>()<span class="sc">$</span><span class="fu">.length</span>()<span class="sc">/</span><span class="dv">50</span>))</span>
<span id="cb295-5"><a href="gans.html#cb295-5" aria-hidden="true" tabindex="-1"></a>gen_losses <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb295-6"><a href="gans.html#cb295-6" aria-hidden="true" tabindex="-1"></a>disc_losses <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb295-7"><a href="gans.html#cb295-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-8"><a href="gans.html#cb295-8" aria-hidden="true" tabindex="-1"></a>img_num <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb295-9"><a href="gans.html#cb295-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (epoch <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_epochs) {</span>
<span id="cb295-10"><a href="gans.html#cb295-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-11"><a href="gans.html#cb295-11" aria-hidden="true" tabindex="-1"></a>    batchnum <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb295-12"><a href="gans.html#cb295-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (b <span class="cf">in</span> <span class="fu">enumerate</span>(dl)) {</span>
<span id="cb295-13"><a href="gans.html#cb295-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-14"><a href="gans.html#cb295-14" aria-hidden="true" tabindex="-1"></a>        batchnum <span class="ot">&lt;-</span> batchnum <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb295-15"><a href="gans.html#cb295-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-16"><a href="gans.html#cb295-16" aria-hidden="true" tabindex="-1"></a>        y_real <span class="ot">&lt;-</span> <span class="fu">torch_ones</span>(b[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">size</span>()[<span class="dv">1</span>], <span class="at">device =</span> device)</span>
<span id="cb295-17"><a href="gans.html#cb295-17" aria-hidden="true" tabindex="-1"></a>        y_fake <span class="ot">&lt;-</span> <span class="fu">torch_zeros</span>(b[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">size</span>()[<span class="dv">1</span>], <span class="at">device =</span> device)</span>
<span id="cb295-18"><a href="gans.html#cb295-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-19"><a href="gans.html#cb295-19" aria-hidden="true" tabindex="-1"></a>        noise <span class="ot">&lt;-</span> <span class="fu">torch_randn</span>(b[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">size</span>()[<span class="dv">1</span>], latent_input_size, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">device =</span> device)</span>
<span id="cb295-20"><a href="gans.html#cb295-20" aria-hidden="true" tabindex="-1"></a>        fake <span class="ot">&lt;-</span> <span class="fu">gen</span>(noise)</span>
<span id="cb295-21"><a href="gans.html#cb295-21" aria-hidden="true" tabindex="-1"></a>        img <span class="ot">&lt;-</span> b[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> device)</span>
<span id="cb295-22"><a href="gans.html#cb295-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-23"><a href="gans.html#cb295-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># update discriminator</span></span>
<span id="cb295-24"><a href="gans.html#cb295-24" aria-hidden="true" tabindex="-1"></a>        disc_loss <span class="ot">&lt;-</span> <span class="fu">criterion</span>(<span class="fu">disc</span>(img), y_real) <span class="sc">+</span> <span class="fu">criterion</span>(<span class="fu">disc</span>(fake<span class="sc">$</span><span class="fu">detach</span>()), y_fake)</span>
<span id="cb295-25"><a href="gans.html#cb295-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-26"><a href="gans.html#cb295-26" aria-hidden="true" tabindex="-1"></a>        disc_optimizer<span class="sc">$</span><span class="fu">zero_grad</span>()</span>
<span id="cb295-27"><a href="gans.html#cb295-27" aria-hidden="true" tabindex="-1"></a>        disc_loss<span class="sc">$</span><span class="fu">backward</span>()</span>
<span id="cb295-28"><a href="gans.html#cb295-28" aria-hidden="true" tabindex="-1"></a>        disc_optimizer<span class="sc">$</span><span class="fu">step</span>()</span>
<span id="cb295-29"><a href="gans.html#cb295-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-30"><a href="gans.html#cb295-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># update generator</span></span>
<span id="cb295-31"><a href="gans.html#cb295-31" aria-hidden="true" tabindex="-1"></a>        gen_loss <span class="ot">&lt;-</span> <span class="fu">criterion</span>(<span class="fu">disc</span>(fake), y_real)</span>
<span id="cb295-32"><a href="gans.html#cb295-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-33"><a href="gans.html#cb295-33" aria-hidden="true" tabindex="-1"></a>        gen_optimizer<span class="sc">$</span><span class="fu">zero_grad</span>()</span>
<span id="cb295-34"><a href="gans.html#cb295-34" aria-hidden="true" tabindex="-1"></a>        gen_loss<span class="sc">$</span><span class="fu">backward</span>()</span>
<span id="cb295-35"><a href="gans.html#cb295-35" aria-hidden="true" tabindex="-1"></a>        gen_optimizer<span class="sc">$</span><span class="fu">step</span>()</span>
<span id="cb295-36"><a href="gans.html#cb295-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-37"><a href="gans.html#cb295-37" aria-hidden="true" tabindex="-1"></a>        disc_losses <span class="ot">&lt;-</span> <span class="fu">c</span>(disc_losses, disc_loss<span class="sc">$</span><span class="fu">cpu</span>()<span class="sc">$</span><span class="fu">item</span>())</span>
<span id="cb295-38"><a href="gans.html#cb295-38" aria-hidden="true" tabindex="-1"></a>        gen_losses <span class="ot">&lt;-</span> <span class="fu">c</span>(gen_losses, gen_loss<span class="sc">$</span><span class="fu">cpu</span>()<span class="sc">$</span><span class="fu">item</span>())</span>
<span id="cb295-39"><a href="gans.html#cb295-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-40"><a href="gans.html#cb295-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (batchnum <span class="sc">%%</span> <span class="dv">50</span> <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb295-41"><a href="gans.html#cb295-41" aria-hidden="true" tabindex="-1"></a>            img_num <span class="ot">&lt;-</span> img_num <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb295-42"><a href="gans.html#cb295-42" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">&quot;Epoch: &quot;</span>, epoch,</span>
<span id="cb295-43"><a href="gans.html#cb295-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;    batch: &quot;</span>, batchnum,</span>
<span id="cb295-44"><a href="gans.html#cb295-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;    disc loss: &quot;</span>, <span class="fu">as.numeric</span>(disc_loss<span class="sc">$</span><span class="fu">cpu</span>()),</span>
<span id="cb295-45"><a href="gans.html#cb295-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;    gen loss: &quot;</span>, <span class="fu">as.numeric</span>(gen_loss<span class="sc">$</span><span class="fu">cpu</span>()),</span>
<span id="cb295-46"><a href="gans.html#cb295-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb295-47"><a href="gans.html#cb295-47" aria-hidden="true" tabindex="-1"></a>            <span class="fu">with_no_grad</span>({</span>
<span id="cb295-48"><a href="gans.html#cb295-48" aria-hidden="true" tabindex="-1"></a>                generated <span class="ot">&lt;-</span> <span class="fu">gen</span>(fixed_noise)</span>
<span id="cb295-49"><a href="gans.html#cb295-49" aria-hidden="true" tabindex="-1"></a>                grid <span class="ot">&lt;-</span> <span class="fu">vision_make_grid</span>(generated)</span>
<span id="cb295-50"><a href="gans.html#cb295-50" aria-hidden="true" tabindex="-1"></a>                img_list[[img_num]] <span class="ot">&lt;-</span> <span class="fu">as_array</span>(grid<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> <span class="st">&quot;cpu&quot;</span>))</span>
<span id="cb295-51"><a href="gans.html#cb295-51" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb295-52"><a href="gans.html#cb295-52" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb295-53"><a href="gans.html#cb295-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-54"><a href="gans.html#cb295-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb295-55"><a href="gans.html#cb295-55" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="artifacts" class="section level2" number="12.4">
<h2><span class="header-section-number">12.4</span> Artifacts</h2>
<p>Now let’s see a few samples of generated images, spread out over training time:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="gans.html#cb296-1" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(img_list), <span class="at">length.out =</span> <span class="dv">16</span>)</span>
<span id="cb296-2"><a href="gans.html#cb296-2" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> img_list[index]</span>
<span id="cb296-3"><a href="gans.html#cb296-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-4"><a href="gans.html#cb296-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="at">mar =</span> <span class="fu">rep</span>(<span class="fl">0.2</span>, <span class="dv">4</span>))</span>
<span id="cb296-5"><a href="gans.html#cb296-5" aria-hidden="true" tabindex="-1"></a>rasterize <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb296-6"><a href="gans.html#cb296-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.raster</span>(x[<span class="dv">1</span>, , ])</span>
<span id="cb296-7"><a href="gans.html#cb296-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb296-8"><a href="gans.html#cb296-8" aria-hidden="true" tabindex="-1"></a>images <span class="sc">%&gt;%</span></span>
<span id="cb296-9"><a href="gans.html#cb296-9" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(rasterize) <span class="sc">%&gt;%</span></span>
<span id="cb296-10"><a href="gans.html#cb296-10" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">iwalk</span>(<span class="sc">~</span>{<span class="fu">plot</span>(.x)})</span></code></pre></div>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="gans.html#cb297-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;images/gan_over_time.png&quot;</span>)</span></code></pre></div>
<p>To my (untrained) eyes, the final results look pretty good! Let’s generate a fresh batch:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="gans.html#cb298-1" aria-hidden="true" tabindex="-1"></a>new <span class="ot">&lt;-</span> <span class="fu">gen</span>(fixed_noise)<span class="sc">$</span><span class="fu">cpu</span>()<span class="sc">$</span><span class="fu">detach</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>, , , ]</span>
<span id="cb298-2"><a href="gans.html#cb298-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-3"><a href="gans.html#cb298-3" aria-hidden="true" tabindex="-1"></a>new <span class="sc">%&gt;%</span> <span class="fu">normalize</span>() <span class="sc">%&gt;%</span></span>
<span id="cb298-4"><a href="gans.html#cb298-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb298-5"><a href="gans.html#cb298-5" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">array_tree</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb298-6"><a href="gans.html#cb298-6" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(rasterize) <span class="sc">%&gt;%</span></span>
<span id="cb298-7"><a href="gans.html#cb298-7" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">iwalk</span>(<span class="sc">~</span>{<span class="fu">plot</span>(.x)})</span></code></pre></div>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="gans.html#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="co"># knitr::include_graphics(&quot;images/gan_over_time.png&quot;)</span></span></code></pre></div>
<p>We can also inspect how the respective losses developed over time:</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="gans.html#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb300-2"><a href="gans.html#cb300-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb300-3"><a href="gans.html#cb300-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-4"><a href="gans.html#cb300-4" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(disc_losses)</span>
<span id="cb300-5"><a href="gans.html#cb300-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-6"><a href="gans.html#cb300-6" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">iteration =</span> iterations, <span class="at">discriminator =</span> disc_losses, <span class="at">generator =</span> gen_losses)</span>
<span id="cb300-7"><a href="gans.html#cb300-7" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb300-8"><a href="gans.html#cb300-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(module, loss, discriminator, generator) <span class="sc">%&gt;%</span></span>
<span id="cb300-9"><a href="gans.html#cb300-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> iteration, <span class="at">y =</span> loss, <span class="at">colour =</span> module)) <span class="sc">+</span></span>
<span id="cb300-10"><a href="gans.html#cb300-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="gans.html#cb301-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;images/gan_losses.png&quot;</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="generative-intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="vaes.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
